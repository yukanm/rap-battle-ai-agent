# Google Agent プロジェクト開発ベンダー向けガイドライン

## 📋 このドキュメントについて

このドキュメントは、Google Agent（AI Rap Battle Arena）プロジェクトの開発に携わる全てのベンダー・開発者が **絶対に守らなければならない** ルールと、プロジェクト開始前に確認すべき情報をまとめたものです。

**⚠️ 重要**: このガイドラインに違反した場合、プロジェクトの品質・セキュリティ・パフォーマンスに深刻な影響を与える可能性があります。

---

## 🏗️ プロジェクト概要

### システム概要
- **プロジェクト名**: AI Agent MC Battle / Google Agent
- **概要**: Google Cloud Vertex AIを活用したリアルタイムAIラップバトルプラットフォーム
- **主要機能**: AIエージェント対戦、リアルタイム音声合成、コンテンツ安全性管理、観客投票システム

### アーキテクチャ種別
- **構成**: モノレポ（npm workspaces）
- **デプロイ**: Google Cloud Platform（Cloud Run）
- **リアルタイム通信**: WebSocket + RESTful API

---

## 🔧 技術スタック（変更禁止）

### 必須ランタイム環境
```bash
Node.js: >= 20.0.0 (厳格)
npm: >= 10.0.0
```

### フロントエンド技術スタック
```json
{
  "framework": "Next.js 14.1.0",
  "language": "TypeScript 5.3.3",
  "ui_library": "React 18.2.0",
  "styling": "Tailwind CSS 3.4.1",
  "animation": "Framer Motion 11.0.0",
  "state_management": "Zustand 4.4.7",
  "data_fetching": "TanStack Query 5.17.0",
  "websocket": "Socket.io-client 4.8.1"
}
```

### バックエンド技術スタック
```json
{
  "runtime": "Node.js + Express.js",
  "language": "TypeScript 5.3.3",
  "ai_framework": "Mastra 0.10.8",
  "google_ai": "Vertex AI (Gemini Flash & Pro)",
  "database": "Firestore + Redis",
  "websocket": "Socket.io 4.6.0",
  "authentication": "JWT",
  "logging": "Winston"
}
```

### インフラストラクチャ
```json
{
  "cloud_provider": "Google Cloud Platform",
  "compute": "Cloud Run",
  "database": "Firestore + Memory Store (Redis)",
  "ai_services": "Vertex AI + Cloud Text-to-Speech",
  "monitoring": "Cloud Logging + Cloud Trace",
  "storage": "Artifact Registry"
}
```

---

## 📁 プロジェクト構造（変更禁止）

```
google-agent/
├── frontend/           # Next.js フロントエンド (ポート: 3456)
├── backend/           # Node.js バックエンド (ポート: 8456)
├── shared/            # 共通ライブラリ（型定義など）
├── e2e-tests/         # Playwright E2Eテスト
├── docs/              # プロジェクトドキュメント
└── scripts/           # デプロイ・運用スクリプト
```

### モノレポルール
- **Workspace管理**: npm workspacesを使用
- **依存関係**: `npm install` は必ずルートで実行
- **ビルド順序**: shared → backend → frontend
- **相互依存**: フロントエンド→バックエンドの直接import禁止

---

## 🚫 絶対禁止事項

### 1. 技術スタック変更禁止
- ❌ **React以外のフロントエンド技術への変更**
- ❌ **Express.js以外のバックエンドフレームワークへの変更**
- ❌ **TypeScript以外の言語の混在**
- ❌ **Google Cloud以外のクラウドプロバイダー使用**

### 2. ポート・URL変更禁止
- ❌ **フロントエンド: 3456以外のポート**
- ❌ **バックエンド: 8456以外のポート**
- ❌ **Redis: 6380以外のポート**

### 3. セキュリティ関連禁止事項
- ❌ **APIキー・機密情報のハードコーディング**
- ❌ **HTTPでの本番環境通信**
- ❌ **サービスアカウントキーのGitコミット**
- ❌ **CORSの全オリジン許可（*）**

### 4. AI・コンテンツ安全性禁止事項
- ❌ **NGワードシステムの無効化**
- ❌ **コンプライアンスチェックのバイパス**
- ❌ **AI生成コンテンツの無制限出力**

---

## ✅ 必須遵守事項

### 1. 開発環境設定
```bash
# 必須環境変数（.env）
GOOGLE_CLOUD_PROJECT_ID=必須
JWT_SECRET=必須（32文字以上）
SESSION_SECRET=必須（32文字以上）
GOOGLE_APPLICATION_CREDENTIALS=必須

# 推奨設定
VERTEX_AI_LOCATION=us-central1
COMPLIANCE_THRESHOLD=0.8
LOG_LEVEL=info
```

### 2. TypeScript設定遵守
```json
{
  "strict": true,
  "noUnusedLocals": true,
  "noUnusedParameters": true,
  "noImplicitReturns": true,
  "noFallthroughCasesInSwitch": true
}
```

### 3. テストカバレッジ要件
- **バックエンド**: 80%以上（branches, functions, lines, statements）
- **フロントエンド**: 75%以上（branches, functions, lines, statements）
- **E2Eテスト**: 全主要フローをカバー

### 4. パフォーマンス要件
```javascript
// 必須性能指標
const PERFORMANCE_REQUIREMENTS = {
  lyricGeneration: "< 1500ms",    // リリック生成
  ttsGeneration: "< 200ms",       // 音声合成
  websocketPing: "< 100ms",       // WebSocket応答
  complianceCheck: "< 300ms"      // コンプライアンスチェック
}
```

### 5. エラーハンドリング
- **全非同期処理**: try-catch必須
- **WebSocket**: 接続切断・再接続処理必須
- **API呼び出し**: リトライ機構実装必須
- **ユーザーフィードバック**: 明確なエラーメッセージ表示必須

---

## 🛡️ セキュリティ要件

### 1. 認証・認可
```typescript
// JWT設定例
const JWT_CONFIG = {
  expiresIn: '24h',
  algorithm: 'HS256',
  issuer: 'ai-rap-battle',
  audience: 'api-users'
}
```

### 2. レート制限
```typescript
// 必須レート制限
const RATE_LIMITS = {
  apiRequests: "60/minute",
  websocketMessages: "10/second",
  battleCreation: "3/minute"
}
```

### 3. データ保護
- **PII（個人識別情報）**: 収集・保存禁止
- **ログ**: 機密情報の出力禁止（APIキー、パスワード等）
- **Cookie**: secure, httpOnly, sameSite属性必須

---

## 🎯 AIエージェント開発規約

### 1. Mastraフレームワーク使用
```typescript
// 標準的なエージェント実装パターン
import { Mastra } from '@mastra/core'

const agent = new Mastra({
  name: 'rap-battle-agent',
  instructions: 'Generate creative rap lyrics...',
  model: {
    provider: 'google',
    name: 'gemini-1.5-flash'
  }
})
```

### 2. AIモデル使用制限
- **Fast応答**: Gemini Flash使用必須
- **Creative応答**: Gemini Pro使用可
- **コスト管理**: 不要なAPI呼び出し禁止
- **トークン制限**: レスポンス長制限必須

### 3. コンテンツ安全性
```typescript
// 必須コンプライアンス設定
const SAFETY_SETTINGS = {
  threshold: 0.8,
  categories: ['harassment', 'violence', 'sexual', 'hate'],
  action: 'block'  // 違反時はブロック必須
}
```

---

## 🧪 テスト戦略

### 1. 単体テスト（Jest）
```bash
# 実行コマンド
npm test                    # 全テスト実行
npm run test:coverage      # カバレッジ付き実行
npm run test:watch         # ウォッチモード
```

### 2. E2Eテスト（Playwright）
```bash
# 必須テストシナリオ
- バトル作成〜終了の完全フロー
- 複数ユーザー同時接続
- エラーハンドリング
- パフォーマンス測定
```

### 3. テスト環境
- **ローカル**: 開発中の継続的テスト
- **CI/CD**: 全プッシュでテスト実行
- **ステージング**: 本番デプロイ前の最終確認

---

## 🚀 デプロイメント規約

### 1. 環境管理
```bash
# 環境別設定
Development  → ローカル環境（Redis: localhost）
Staging     → GCP開発環境（限定機能）
Production  → GCP本番環境（全機能有効）
```

### 2. Cloud Run設定
```yaml
# 必須設定値
resources:
  cpu: 1
  memory: 2Gi
  max_instances: 100
environment:
  NODE_ENV: production
  PORT: 8080
```

### 3. デプロイフロー
1. **コード品質チェック**: lint + test必須
2. **セキュリティスキャン**: 機密情報チェック
3. **ビルド検証**: 全ワークスペースビルド成功
4. **ステージングテスト**: E2Eテスト完全通過
5. **本番デプロイ**: Blue-Green方式

---

## 📊 監視・ログ

### 1. 必須監視項目
```javascript
const MONITORING_METRICS = {
  responseTime: "< 1.5s",
  errorRate: "< 1%",
  availability: "> 99.9%",
  concurrentUsers: "監視必須"
}
```

### 2. ログレベル
```typescript
// 必須ログ設定
const LOG_LEVELS = {
  production: 'info',   // 本番環境
  development: 'debug', // 開発環境
  test: 'error'        // テスト環境
}
```

### 3. アラート設定
- **エラー率 > 5%**: 即座通知
- **応答時間 > 3秒**: 警告
- **API制限接近**: 事前通知

---

## 🔄 コード規約

### 1. ファイル・ディレクトリ命名
```bash
# ファイル命名規則
components/     → PascalCase (ButtonComponent.tsx)
services/       → camelCase (battleService.ts)
utils/          → camelCase (formatDate.ts)
types/          → camelCase (battleTypes.ts)
```

### 2. Import/Export規約
```typescript
// 推奨パターン
import { specificFunction } from './module'  // 名前付きimport
export { default as ComponentName }         // 再エクスポート
export type { TypeName }                    // 型エクスポート

// 禁止パターン
import * as Everything from './module'      // 全体import禁止
export default                              // デフォルトエクスポート制限
```

### 3. エラーハンドリングパターン
```typescript
// 必須パターン
try {
  const result = await apiCall()
  return { success: true, data: result }
} catch (error) {
  logger.error('Operation failed', { error, context })
  return { success: false, error: 'User-friendly message' }
}
```

---

## 📚 必須確認ドキュメント

開発開始前に以下のドキュメントを **必ず** 読むこと：

1. **[README.md](../README.md)** - プロジェクト概要とクイックスタート
2. **[docs/architecture.md](./architecture.md)** - システムアーキテクチャ詳細
3. **[docs/LOCAL_SETUP.md](./LOCAL_SETUP.md)** - ローカル環境構築手順
4. **[docs/ng-word-system.md](./ng-word-system.md)** - NGワードシステム仕様
5. **[docs/TEST_SCENARIOS.md](./TEST_SCENARIOS.md)** - テストシナリオ
6. **[docs/OPERATION_MANUAL.md](./OPERATION_MANUAL.md)** - 運用手順
7. **[backend/src/services/AGENT_README.md](../backend/src/services/AGENT_README.md)** - AIエージェント仕様

---

## 🚨 緊急時対応

### 1. 障害対応フロー
1. **即座報告**: プロジェクトマネージャーに連絡
2. **ログ確認**: Cloud Loggingでエラー原因特定
3. **ロールバック**: 必要に応じて前バージョンに戻す
4. **修正・再デプロイ**: 原因修正後に段階的デプロイ

### 2. セキュリティインシデント
1. **システム停止**: 疑わしい活動を検知した場合
2. **証跡保全**: ログ・データの保護
3. **関係者通知**: ステークホルダーへの報告
4. **対策実施**: セキュリティ強化措置

---

## ✋ 質問・疑問点がある場合

### 開発中の質問
1. **技術的質問**: 技術リーダーに相談
2. **仕様確認**: プロダクトオーナーに確認
3. **緊急事項**: プロジェクトマネージャーに即座連絡

### ドキュメント更新
- このガイドラインに追加・修正が必要な場合は、必ずプロジェクトチームに確認してから更新すること
- 変更履歴を必ず記録すること

---

## 📝 確認チェックリスト

開発開始前に以下をチェックすること：

### 環境確認
- [ ] Node.js 20+ インストール済み
- [ ] Google Cloud SDK設定済み
- [ ] Docker環境構築済み
- [ ] プロジェクトクローン完了
- [ ] .env設定完了
- [ ] npm install成功

### ドキュメント確認
- [ ] README.md読了
- [ ] 技術アーキテクチャ理解
- [ ] ローカル環境構築完了
- [ ] テストシナリオ把握
- [ ] NGワードシステム理解

### 開発準備
- [ ] 開発ブランチ作成
- [ ] IDE/エディタ設定完了
- [ ] デバッグ環境確認
- [ ] テスト実行確認

---

**⚠️ 最重要**: このガイドラインを遵守することで、高品質・高セキュリティ・高パフォーマンスなAIエージェントシステムの構築が可能になります。疑問点があれば必ず確認してから作業を進めてください。 